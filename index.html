<!doctype html>
<html lang="ru" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Меню Доставки</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <style type="text/tailwindcss">
        @layer components {
            .menu-category-title {
                @apply text-3xl md:text-4xl text-[#3b443d] font-bold tracking-tight text-center border-b-2 border-[#597e52]/40 mt-10 mb-6 pb-3;
            }
            .navelement {
                @apply tracking-tight text-lg text-[#3b443d] hover:text-[#597e52] font-semibold px-4 py-2 rounded-lg transition duration-200 ease-in-out hover:bg-[#597e52]/10;
            }
            .navelement.active {
                @apply text-[#597e52] bg-[#597e52]/10;
            }
            /* ИЗМЕНЕНО: grid-cols-1 -> grid-cols-2, gap-5 -> gap-4 */
            .menu-category-grid{
                @apply grid grid-cols-2 sm:grid-cols-2 lg:grid-cols-4 gap-4 md:gap-6
            }
            .menu-category-card {
                @apply bg-white border border-gray-200 rounded-xl shadow-sm transition-all duration-300 hover:shadow-lg hover:border-[#597e52]/30 overflow-hidden;
            }
            .menu-category-card-image {
                @apply w-full object-cover block h-48 sm:h-52 bg-gray-100;
            }
            .menu-category-card-content {
                @apply p-4 md:p-5;
            }
            .menu-category-card-text {
                @apply text-xl md:text-2xl font-bold mb-2 tracking-tight text-[#3b443d];
            }
            .menu-category-card-text-desc {
                @apply text-[#3b443d]/70 mb-4 text-sm leading-relaxed line-clamp-2;
            }

            .menu-category-card-parent {
                @apply flex flex-col justify-between gap-2 mt-auto pt-3 border-t border-gray-100;
            }
            .menu-category-card-parent-price {
                @apply text-2xl md:text-3xl font-bold tracking-tight text-[#597e52];
            }

            .quantity-controls {
                @apply flex items-center justify-between gap-2 bg-[#597e52]/10 rounded-full p-1;
            }

            .quantity-btn {
                @apply w-8 h-8 flex items-center justify-center rounded-full bg-[#597e52] text-white font-bold text-lg transition-all duration-200 hover:bg-[#4a6945] active:scale-95 shadow-sm hover:shadow-md;
            }

            .quantity-display {
                @apply min-w-[40px] text-center text-lg font-bold text-[#3b443d];
            }

            .add-to-cart-btn {
                @apply px-5 py-2.5 bg-[#597e52] text-white font-semibold rounded-full transition-all duration-200 hover:bg-[#4a6945] active:scale-95 shadow-sm hover:shadow-md text-sm;
            }

            .cart-notification {
                @apply fixed right-5 w-[360px] h-[150px] bg-white/95 rounded-2xl shadow-lg p-2 backdrop-blur-md z-50 transition-all duration-300 ease-in-out opacity-0 translate-y-10 border border-gray-200;
            }
            .cart-notification.visible {
                @apply opacity-100 translate-y-0;
            }
            #floating-cart-btn {
                /* ИЗМЕНЕНИЕ: Стили для плавающей кнопки корзины */
                @apply fixed bottom-6 right-6 z-50;
            }

            #cart-btn:hover {
                @apply scale-110;
                transform: translateY(-2px);
            }

            #cart-count {
                @apply scale-0 transition-transform duration-200;
            }
        }
    </style>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                },
            },
        }
    </script>
</head>
<body class="bg-[#f4eee1] text-[#3b443d] font-sans">
<div class="container mx-auto p-4 sm:p-10 max-w-7xl">
    <h1 class="text-4xl md:text-5xl font-bold text-center mb-10 tracking-tight">Меню</h1>

    <div class="sticky top-0 z-10 bg-white shadow-md border-b border-gray-200">
        <div class="container mx-auto max-w-7xl px-4">
            <nav class="flex w-full justify-start md:justify-center overflow-x-auto overflow-y-none space-x-2 py-3 pr-20 md:pr-0">
            </nav>
        </div>
    </div>
</div>
<div id="order-success-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
    <div class="bg-white p-8 rounded-2xl shadow-xl w-full max-w-md text-center mx-4">
        <svg class="w-16 h-16 text-green-500 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
        </svg>
        <h2 class="text-2xl font-bold mb-2">Заказ оформлен!</h2>
        <p class="text-[#3b443d]/70 mb-6">Мы приняли ваш заказ. Ожидайте, скоро принесём!</p>
        <button id="close-order-modal" class="px-6 py-3 bg-[#597e52] text-white font-semibold rounded-lg hover:scale-105 transition">
            Окей
        </button>
    </div>
</div>
<div id="notification-container"></div>

<div id="floating-cart-btn" class="transition-all duration-300">
    <button id="cart-btn" class="relative w-14 h-14 bg-[#597e52] text-white rounded-full shadow-lg hover:shadow-xl transition-all duration-300 flex items-center justify-center group">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4m0 0L7 13m0 0l-1.5 7.5M7 13l1.5 7.5M16 13l1.5 7.5"></path>
        </svg>
        <span id="cart-count" class="absolute -top-1 -right-1 bg-red-500 text-xs w-6 h-6 rounded-full flex items-center justify-center text-white font-bold min-w-[24px]">
            0
        </span>
    </button>
</div>

<script>
    function isTokenExpired(token) {
        if (!token) return true;
        const parts = token.split('.');
        if (parts.length !== 3) return true;
        try {
            const payload = JSON.parse(atob(parts[1]));
            const savedTime = localStorage.getItem('tableTokenSavedAt');
            if (!savedTime) return true;
            const tokenAgeMs = Date.now() - parseInt(savedTime, 10);
            const oneDayMs = 24 * 60 * 60 * 1000;
            if (tokenAgeMs > oneDayMs) return true;
            const now = Math.floor(Date.now() / 1000);
            return payload.exp < now;
        } catch (e) {
            return true;
        }
    }

    const tableNumber = localStorage.getItem('tableNumber');
    if (!tableNumber || isTokenExpired(tableNumber)) {
        localStorage.removeItem('tableNumber');
        window.location.href = './redirect.html';
    } else {
        function createMenuCard(item) {
            const card = document.createElement('div');
            card.className = 'menu-category-card';

            const img = document.createElement('img');
            img.alt = item.name || '';
            img.src = item.image || 'src/images/placeholder.jpg';
            img.className = 'menu-category-card-image';
            card.appendChild(img);

            const content = document.createElement('div');
            content.className = 'menu-category-card-content';

            const title = document.createElement('h3');
            title.className = 'menu-category-card-text';
            title.textContent = item.name;
            content.appendChild(title);

            const desc = document.createElement('p');
            desc.className = 'menu-category-card-text-desc';
            desc.textContent = item.description;
            content.appendChild(desc);

            const parent = document.createElement('div');
            parent.className = 'menu-category-card-parent';

            const price = document.createElement('p');
            price.className = 'menu-category-card-parent-price';
            price.textContent = `${item.price} ₽`;
            parent.appendChild(price);

            const cart = JSON.parse(localStorage.getItem('cart')) || [];
            const cartItem = cart.find(i => i.id === item.id);
            const quantity = cartItem ? cartItem.quantity : 0;

            if (quantity > 0) {
                const controls = document.createElement('div');
                controls.className = 'quantity-controls';

                const minus = document.createElement('button');
                minus.className = 'quantity-btn';
                minus.textContent = '-';
                minus.onclick = () => updateCart(item, -1);
                controls.appendChild(minus);

                const display = document.createElement('span');
                display.className = 'quantity-display';
                display.textContent = quantity;
                controls.appendChild(display);

                const plus = document.createElement('button');
                plus.className = 'quantity-btn';
                plus.textContent = '+';
                plus.onclick = () => updateCart(item, 1);
                controls.appendChild(plus);

                parent.appendChild(controls);
            } else {
                const addBtn = document.createElement('button');
                addBtn.className = 'add-to-cart-btn';
                addBtn.textContent = 'Добавить';
                addBtn.onclick = () => updateCart(item, 1);
                parent.appendChild(addBtn);
            }

            content.appendChild(parent);
            card.appendChild(content);

            return card;
        }

        function updateCart(item, delta) {
            let cart = JSON.parse(localStorage.getItem('cart')) || [];
            let cartItem = cart.find(i => i.id === item.id);

            if (cartItem) {
                cartItem.quantity += delta;
                if (cartItem.quantity <= 0) {
                    cart = cart.filter(i => i.id !== item.id);
                    showNotification(item, true);
                }
            } else if (delta > 0) {
                cartItem = { ...item, quantity: 1 };
                cart.push(cartItem);
                showNotification(item);
            }

            localStorage.setItem('cart', JSON.stringify(cart));
            updateCartButton();

            const card = document.querySelector(`[data-item-id="${item.id}"]`);
            if (card) {
                const parent = card.querySelector('.menu-category-card-parent');
                const quantity = cartItem ? cartItem.quantity : 0;

                const existingControls = parent.querySelector('.quantity-controls');
                const existingBtn = parent.querySelector('.add-to-cart-btn');

                if (existingControls) existingControls.remove();
                if (existingBtn) existingBtn.remove();

                if (quantity > 0) {
                    const controls = document.createElement('div');
                    controls.className = 'quantity-controls';

                    const minus = document.createElement('button');
                    minus.className = 'quantity-btn';
                    minus.textContent = '-';
                    minus.onclick = () => updateCart(item, -1);
                    controls.appendChild(minus);

                    const display = document.createElement('span');
                    display.className = 'quantity-display';
                    display.textContent = quantity;
                    controls.appendChild(display);

                    const plus = document.createElement('button');
                    plus.className = 'quantity-btn';
                    plus.textContent = '+';
                    plus.onclick = () => updateCart(item, 1);
                    controls.appendChild(plus);

                    parent.appendChild(controls);
                } else {
                    const addBtn = document.createElement('button');
                    addBtn.className = 'add-to-cart-btn';
                    addBtn.textContent = 'Добавить';
                    addBtn.onclick = () => updateCart(item, 1);
                    parent.appendChild(addBtn);
                }
            }
        }

        function updateNotificationPositions() {
            const container = document.getElementById('notification-container');
            const notifications = Array.from(container.children);
            notifications.forEach((notification, index) => {
                notification.style.bottom = `${index * 160 + 40}px`;
            });
        }

        function showNotification(item, isRemoval = false) {
            const container = document.getElementById('notification-container');
            const notifications = container.children;
            const currentCount = notifications.length;
            const isMobile = window.innerWidth < 768;
            const maxNotifications = isMobile ? 1 : 3;
            let delay = 0;

            if (currentCount >= maxNotifications) {
                const oldestNotification = notifications[0];
                if (oldestNotification) {
                    hideNotification(oldestNotification.id);
                    delay = 310;
                }
            }

            setTimeout(() => {
                const notificationId = `cart-notification-${Date.now()}-${Math.random()}`;
                const notification = document.createElement('div');
                notification.id = notificationId;
                notification.className = 'cart-notification';
                notification.style.bottom = `${container.childElementCount * 160 + 40}px`;

                notification.innerHTML = `
                    <div class="card-wrapper flex flex-nowrap items-center w-full h-full">
                        <div class="card-icon w-1/5">
                            <div class="icon-cart-box bg-[#597e52]/15 w-12 h-12 rounded-full text-center p-3 mx-auto flex items-center justify-center">
                                <svg xmlns="http://www.w3.org/2000/svg" height="20" width="20" viewBox="0 0 576 512" fill="#597e52">
                                    <path d="M0 24C0 10.7 10.7 0 24 0H69.5c22 0 41.5 12.8 50.6 32h411c26.3 0 45.5 25 38.6 50.4l-41 152.3c-8.5 31.4-37 53.3-69.5 53.3H170.7l5.4 28.5c2.2 11.3 12.1 19.5 23.6 19.5H488c13.3 0 24 10.7 24 24s-10.7 24-24 24H199.7c-34.6 0-64.3-24.6-70.7-58.5L77.4 54.5c-.7-3.8-4-6.5-7.9-6.5H24C10.7 48 0 37.3 0 24zM128 464a48 48 0 1 1 96 0 48 48 0 1 1 -96 0zm336-48a48 48 0 1 1 0 96 48 48 0 1 1 0-96z"></path>
                                </svg>
                            </div>
                        </div>
                        <div class="card-content w-4/5 flex flex-col justify-between h-full py-2">
                            <div class="card-title-wrapper flex flex-nowrap items-center justify-between w-full">
                                <span class="card-title text-base font-semibold text-[#3b443d] pl-2">${isRemoval ? 'Удалено из корзины!' : 'Добавлено в корзину!'}</span>
                                <svg xmlns="http://www.w3.org/2000/svg" height="14" width="14" viewBox="0 0 384 512" class="cursor-pointer fill-[#3b443d]/30 transition-all duration-200 hover:fill-[#3b443d] mr-2" onclick="hideNotification('${notificationId}')">
                                    <path d="M342.6 150.6c12.5-12.5 12.5-32.8 0-45.3s-32.8-12.5-45.3 0L192 210.7 86.6 105.4c-12.5-12.5-32.8-12.5-45.3 0s-12.5 32.8 0 45.3L146.7 256 41.4 361.4c-12.5 12.5-12.5 32.8 0 45.3s32.8 12.5 45.3 0L192 301.3 297.4 406.6c12.5 12.5 32.8 12.5 45.3 0s12.5-32.8 0-45.3L237.3 256 342.6 150.6z"></path>
                                </svg>
                            </div>
                            <div class="product-name text-sm text-[#3b443d]/80 pl-2 font-medium">${item.name}</div>
                            <div class="flex items-center justify-between pl-2 pr-2">
                                <div class="product-price text-base font-bold text-[#597e52]">${item.price} ₽</div>
                                <button onclick="window.location.href='./cart.html'" class="button transition-all duration-200 py-1.5 px-3 bg-[#597e52] rounded-full flex items-center justify-center text-white gap-1.5 font-semibold text-xs cursor-pointer hover:bg-[#4a6945]">
                                    Корзина
                                    <svg class="w-4 h-4" viewBox="0 0 24 24" fill="currentColor">
                                        <path fill-rule="evenodd" d="M12 2.25c-5.385 0-9.75 4.365-9.75 9.75s4.365 9.75 9.75 9.75 9.75-4.365 9.75-9.75S17.385 2.25 12 2.25zm4.28 10.28a.75.75 0 000-1.06l-3-3a.75.75 0 10-1.06 1.06l1.72 1.72H8.25a.75.75 0 000 1.5h5.69l-1.72 1.72a.75.75 0 101.06 1.06l3-3z" clip-rule="evenodd"></path>
                                    </svg>
                                </button>
                            </div>
                        </div>
                    </div>
                `;

                container.appendChild(notification);
                setTimeout(() => notification.classList.add('visible'), 100);
                setTimeout(() => hideNotification(notificationId), 1500);
            }, delay);
        }

        function hideNotification(notificationId) {
            const notification = document.getElementById(notificationId);
            if (notification) {
                notification.classList.remove('visible');
                setTimeout(() => {
                    notification.remove();
                    updateNotificationPositions();
                }, 300);
            }
        }

        async function loadMenu() {
            try {
                const response = await fetch('http://localhost:3000/api/menu');
                if (!response.ok) throw new Error('Ошибка загрузки меню');
                const data = await response.json();
                const categories = data.categories;

                if (!categories || typeof categories !== 'object') {
                    console.error('Неверный формат категорий:', categories);
                    return;
                }

                const container = document.querySelector('.container.mx-auto.p-4');
                const nav = document.querySelector('nav');
                nav.innerHTML = '';

                Object.entries(categories).forEach(([catKey, catData]) => {
                    const link = document.createElement('a');
                    link.href = `#${catKey}`;
                    link.className = 'navelement whitespace-nowrap';
                    link.textContent = catData.name;
                    nav.appendChild(link);

                    const section = document.createElement('section');
                    section.className = 'mb-12';

                    const h2 = document.createElement('h2');
                    h2.id = catKey;
                    h2.className = 'menu-category-title';
                    h2.textContent = catData.name;
                    section.appendChild(h2);

                    const grid = document.createElement('div');
                    grid.className = 'menu-category-grid';

                    catData.items.forEach(item => {
                        const card = createMenuCard(item);
                        card.dataset.itemId = item.id;
                        grid.appendChild(card);
                    });

                    section.appendChild(grid);
                    container.appendChild(section);
                });
            } catch (error) {
                console.error('Ошибка:', error);
            }
        }

        function updateCartButton() {
            const cart = JSON.parse(localStorage.getItem('cart')) || [];
            const totalItems = cart.reduce((sum, item) => sum + item.quantity, 0);
            const countEl = document.getElementById('cart-count');
            const btn = document.getElementById('cart-btn');

            countEl.textContent = totalItems;
            if (totalItems > 0) {
                countEl.classList.remove('scale-0');
                countEl.classList.add('scale-100');
            } else {
                countEl.classList.remove('scale-100');
                countEl.classList.add('scale-0');
            }

            btn.onclick = () => window.location.href = './cart.html';
        }

        async function init() {
            await loadMenu();
            updateCartButton();

            const navLinks = document.querySelectorAll('.navelement');
            const sections = document.querySelectorAll('section');

            const scrollFunction = () => {
                let current = '';
                sections.forEach(section => {
                    const sectionTop = section.offsetTop;
                    // Скорректирован отступ для определения текущей секции, учитывая высоту фиксированной навигации
                    if (window.pageYOffset >= sectionTop - 120) {
                        current = section.querySelector('h2').getAttribute('id');
                    }
                });

                navLinks.forEach(link => {
                    link.classList.remove('active');
                    if (link.getAttribute('href') === '#' + current) {
                        link.classList.add('active');
                    }
                });
            };

            window.addEventListener('scroll', scrollFunction);
            scrollFunction();

            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.get('modal') === 'ordered') {
                const modal = document.getElementById('order-success-modal');
                if (modal) modal.classList.remove('hidden');

                document.getElementById('close-order-modal').addEventListener('click', () => {
                    modal.classList.add('hidden');
                    const newUrl = window.location.pathname;
                    window.history.replaceState({}, '', newUrl);
                });
            }
        }

        window.addEventListener('DOMContentLoaded', init);
    }
</script>
</body>
</html>